# ğŸ” åå°„æœºåˆ¶

## åå°„æ¦‚è¿°

åå°„ï¼ˆReflectionï¼‰å…è®¸ç¨‹åºåœ¨è¿è¡Œæ—¶è·å–ç±»çš„ä¿¡æ¯å¹¶æ“ä½œå¯¹è±¡ã€‚

```
       æºç            ç¼–è¯‘             è¿è¡ŒæœŸ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ .java    â”‚â†’ â”‚ .class   â”‚ â†’  â”‚ Class<?> å…ƒä¿¡æ¯â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                 åå°„ APIï¼ˆField/Method/Constructorï¼‰
                                         â”‚
                                   invoke/get/set ç­‰æ“ä½œ
```

åå°„çš„å…¸å‹åº”ç”¨ï¼šæ¡†æ¶çš„ä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰ã€åºåˆ—åŒ–ã€å¯¹è±¡æ˜ å°„ã€AOPã€SPI æœåŠ¡åŠ è½½ç­‰ã€‚

## Class å¯¹è±¡

### è·å– Class å¯¹è±¡

```java
// æ–¹å¼1ï¼šé€šè¿‡ç±»å
Class<?> clazz = String.class;

// æ–¹å¼2ï¼šé€šè¿‡å¯¹è±¡
String str = "Hello";
Class<?> clazz = str.getClass();

// æ–¹å¼3ï¼šé€šè¿‡ç±»åå­—ç¬¦ä¸²
Class<?> clazz = Class.forName("java.lang.String");
```

### ç±»åŠ è½½ä¸å¯è§æ€§ï¼ˆä¸æ¨¡å—åŒ–çš„å…³ç³»ï¼‰

```
ClassLoader å±‚æ¬¡ï¼š
Bootstrap â†’ Platform â†’ Application â†’ è‡ªå®šä¹‰

åŒäº²å§”æ´¾ï¼šä¼˜å…ˆçˆ¶åŠ è½½ï¼Œé¿å…æ ¸å¿ƒç±»è¢«è¦†ç›–ã€‚
JPMSï¼šæœªå¯¼å‡ºçš„åŒ…é»˜è®¤å¯¹å¤–ä¸å¯è§ï¼Œåå°„éœ€é…åˆ opensã€‚
```

```bash
# è¿è¡ŒæœŸå¼€æ”¾åå°„ï¼ˆç¤ºä¾‹ï¼‰
java --add-opens com.example.app/com.example.pkg=org.hibernate.orm.core
```

## åˆ›å»ºå¯¹è±¡

### ä½¿ç”¨åå°„åˆ›å»ºå¯¹è±¡

```java
// è·å– Class å¯¹è±¡
Class<?> clazz = Class.forName("com.example.Person");

// åˆ›å»ºå®ä¾‹
Person person = (Person) clazz.newInstance();

// ä½¿ç”¨æ„é€ æ–¹æ³•
Constructor<?> constructor = clazz.getConstructor(String.class, int.class);
Person person = (Person) constructor.newInstance("å¼ ä¸‰", 25);
```

æ³¨æ„ï¼š`Class#newInstance()` å·²è¿‡æ—¶ï¼Œæ¨èä½¿ç”¨æ„é€ å™¨å¯¹è±¡ï¼›é…åˆç¼“å­˜é¿å…é‡å¤å¼€é”€ã€‚

```java
private static final ConcurrentMap<List<Class<?>>, Constructor<?>> CTOR_CACHE = new ConcurrentHashMap<>();

static <T> T newInstance(Class<T> type, Class<?>[] sig, Object... args) {
    try {
        Constructor<?> c = CTOR_CACHE.computeIfAbsent(Arrays.asList(sig), k -> {
            try { Constructor<?> cc = type.getDeclaredConstructor(k.toArray(new Class<?>[0])); cc.setAccessible(true); return cc; }
            catch (Exception e) { throw new RuntimeException(e); }
        });
        @SuppressWarnings("unchecked") T t = (T) c.newInstance(args);
        return t;
    } catch (Exception e) {
        throw new RuntimeException(e);
    }
}
```

## è®¿é—®å­—æ®µ

```java
Class<?> clazz = Person.class;

// è·å–å­—æ®µ
Field nameField = clazz.getDeclaredField("name");
nameField.setAccessible(true);  // å…è®¸è®¿é—®ç§æœ‰å­—æ®µ

// è·å–å’Œè®¾ç½®å€¼
Person person = new Person();
nameField.set(person, "æå››");
String name = (String) nameField.get(person);
```

å°è´´å£«ï¼šé¢‘ç¹è°ƒç”¨ `setAccessible(true)` æœ‰å®‰å…¨ä¸æ€§èƒ½ä»£ä»·ï¼›ä¼˜å…ˆæ‰¹é‡åˆå§‹åŒ–åå¤ç”¨ `Field` å¼•ç”¨ã€‚

## è°ƒç”¨æ–¹æ³•

```java
Class<?> clazz = Person.class;

// è·å–æ–¹æ³•
Method method = clazz.getMethod("setName", String.class);

// è°ƒç”¨æ–¹æ³•
Person person = new Person();
method.invoke(person, "ç‹äº”");
```

### MethodHandle ä¸ VarHandleï¼ˆé«˜æ€§èƒ½åå°„ï¼‰

`MethodHandle` æä¾›è½»é‡ã€å¯å†…è”çš„è°ƒç”¨å¥æŸ„ï¼›`VarHandle` æä¾›å—æ§çš„å†…å­˜è¯­ä¹‰è®¿é—®ï¼ˆå«åŸå­/æœ‰åºï¼‰ã€‚

```java
MethodHandles.Lookup lookup = MethodHandles.lookup();
MethodHandle mh = lookup.findVirtual(Person.class, "setName",
        MethodType.methodType(void.class, String.class));
mh.invokeExact(new Person(), "èµµå…­");
```

```java
VarHandle NAME;
static {
    try {
        NAME = MethodHandles.lookup()
            .findVarHandle(Person.class, "name", String.class);
    } catch (Exception e) { throw new RuntimeException(e); }
}
// åŸå­/æœ‰åºæ“ä½œç¤ºä¾‹
NAME.setRelease(person, "é’±ä¸ƒ");
```

æ€§èƒ½è¦ç‚¹ï¼šJIT å¯å¯¹ `MethodHandle` ä¼˜åŒ–å†…è”ï¼›å¸¸è§„åå°„ `Method#invoke` é€šå¸¸æ›´æ…¢ã€‚

## å®Œæ•´ç¤ºä¾‹

```java
public class ReflectionExample {
    public static void main(String[] args) throws Exception {
        // è·å– Class å¯¹è±¡
        Class<?> clazz = Class.forName("com.example.Person");
        
        // åˆ›å»ºå¯¹è±¡
        Person person = (Person) clazz.newInstance();
        
        // è®¿é—®å­—æ®µ
        Field nameField = clazz.getDeclaredField("name");
        nameField.setAccessible(true);
        nameField.set(person, "å¼ ä¸‰");
        
        // è°ƒç”¨æ–¹æ³•
        Method setNameMethod = clazz.getMethod("setName", String.class);
        setNameMethod.invoke(person, "æå››");
        
        System.out.println(person.getName());
    }
}
```

## æ€§èƒ½ã€å¯ç»´æŠ¤ä¸å®‰å…¨è¾¹ç•Œ

- æ€§èƒ½ï¼š
  - åå°„è°ƒç”¨æ…¢äºç›´å‘¼ï¼›`MethodHandle` é€šå¸¸ä¼˜äº `Method#invoke`ï¼›ç¼“å­˜å…ƒæ•°æ®å¯¹è±¡ã€‚
  - é¿å…çƒ­è·¯å¾„ä¸Šé¢‘ç¹åå°„ï¼›å¯ç”¨ä»£ç ç”Ÿæˆï¼ˆByteBuddy/Javassistï¼‰æˆ–è®°å½•-å›æ”¾æ¨¡å¼ã€‚
- å¯ç»´æŠ¤ï¼š
  - åå°„ç»•è¿‡å°è£…ï¼ŒAPI å˜æ›´éš¾ä»¥è¢«ç¼–è¯‘æœŸå‘ç°ï¼Œéœ€å®Œå–„æµ‹è¯•ã€‚
- å®‰å…¨ä¸æ¨¡å—åŒ–ï¼š
  - JPMS ä¸‹æœªå¯¼å‡ºåŒ…ä¸å¯åå°„è®¿é—®ï¼Œéœ€ `opens` ç²¾ç¡®æˆæƒåˆ°ç‰¹å®šæ¨¡å—ã€‚
  - æœ€å°æƒé™åŸåˆ™ï¼šé¿å… `open module` å…¨é‡å¼€æ”¾ã€‚

## å›¾ç¤ºï¼šåå°„ä¸æ¨¡å—åŒ–è®¿é—®çŸ©é˜µ

```
               | æºç å¯è§ | ç¼–è¯‘å¯è§ | è¿è¡ŒæœŸå¯åå°„ | å¤‡æ³¨
---------------+---------+---------+------------+----------------------
exports         |    âœ”    |    âœ”    |     âœ–      | éœ€å¦è¡Œ opens æ‰å¯åå°„
opens           |    âœ–    |    âœ–    |     âœ”      | ä»…é™è¿è¡ŒæœŸåå°„
exports+opens   |    âœ”    |    âœ”    |     âœ”      | API + åå°„éƒ½å¯ç”¨
æœªå¯¼å‡º/æœªå¼€æ”¾   |    âœ–    |    âœ–    |     âœ–      | é»˜è®¤å¼ºå°è£…
```

## å®æˆ˜ï¼šJackson åœ¨ JPMS ä¸‹çš„æœ€å°é…ç½®

```java
module com.example.app {
    requires com.fasterxml.jackson.databind;
    opens com.example.app.dto to com.fasterxml.jackson.databind;
}
```

## å®æˆ˜ï¼šJPA/Hibernate å®ä½“æ‰«æ

```java
module com.example.app {
    requires org.hibernate.orm.core;
    opens com.example.app.entity to org.hibernate.orm.core;
}
```

## ä¸‹ä¸€æ­¥

æŒæ¡äº†åå°„æœºåˆ¶åï¼Œå¯ä»¥ç»§ç»­å­¦ä¹ ï¼š

- [æ¨¡å—åŒ–ä¸åŒ…ç®¡ç†](/java/23-æ¨¡å—åŒ–ä¸åŒ…ç®¡ç†.md) - å­¦ä¹ æ¨¡å—åŒ–
- [å•å…ƒæµ‹è¯•](/java/24-å•å…ƒæµ‹è¯•.md) - å­¦ä¹ å•å…ƒæµ‹è¯•

---

<div style="text-align: center; margin-top: 2rem;">
  <p>ğŸ’¡ <strong>æç¤º</strong>ï¼šåå°„æä¾›äº†å¼ºå¤§çš„åŠ¨æ€ç¼–ç¨‹èƒ½åŠ›ï¼Œä½†è¦è°¨æ…ä½¿ç”¨</p>
</div>
