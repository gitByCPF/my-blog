# ğŸ”„ å¹¶å‘ç¼–ç¨‹é«˜çº§

## å¹¶å‘ç¼–ç¨‹é«˜çº§ä¸»é¢˜

æ·±å…¥å­¦ä¹ å¹¶å‘ç¼–ç¨‹çš„é«˜çº§æŠ€æœ¯å’Œæœ€ä½³å®è·µã€‚

```
å…³æ³¨ç‚¹ï¼šå¯è§æ€§/æœ‰åºæ€§ â†’ é”ç«äº‰ä¸ä¼ªå…±äº« â†’ æ— é”/CAS â†’ å¯ä¼¸ç¼©æ€§ä¸æ´»æ€§
```

## çº¿ç¨‹å®‰å…¨

### çº¿ç¨‹å®‰å…¨é›†åˆ

```java
// çº¿ç¨‹å®‰å…¨çš„é›†åˆ
ConcurrentHashMap<String, String> map = new ConcurrentHashMap<>();
CopyOnWriteArrayList<String> list = new CopyOnWriteArrayList<>();

// ä½¿ç”¨åŒæ­¥åŒ…è£…
List<String> synchronizedList = Collections.synchronizedList(new ArrayList<>());
```

### åŸå­ç±»

```java
// åŸå­ç±»
AtomicInteger count = new AtomicInteger(0);
count.incrementAndGet();
count.compareAndSet(0, 10);
```

### LongAdder/Stripedï¼ˆé«˜å¹¶å‘è®¡æ•°ï¼‰

```java
LongAdder adder = new LongAdder();
IntStream.range(0, 1_000_000).parallel().forEach(i -> adder.increment());
long sum = adder.sum();
```

## é”æœºåˆ¶

### ReentrantLock

```java
ReentrantLock lock = new ReentrantLock();

lock.lock();
try {
    // ä¸´ç•ŒåŒºä»£ç 
} finally {
    lock.unlock();
}
```

### ReadWriteLock

```java
ReadWriteLock rwLock = new ReentrantReadWriteLock();
Lock readLock = rwLock.readLock();
Lock writeLock = rwLock.writeLock();
```

### StampedLockï¼ˆä¹è§‚è¯»ï¼‰

```java
var lock = new StampedLock();
long stamp = lock.tryOptimisticRead();
int x = data;
if (!lock.validate(stamp)) { stamp = lock.readLock(); try { x = data; } finally { lock.unlockRead(stamp);} }
```

### é”ä¼˜åŒ–ä¸é¿å…æ­»é”

- å°½é‡ç»†ç²’åº¦ä¸çŸ­ä¸´ç•ŒåŒºï¼›ç»Ÿä¸€åŠ é”é¡ºåºï¼›è¶…æ—¶è·å–ï¼›é”åˆ†ç¦»ï¼ˆè¯»å†™/æ®µé”ï¼‰ï¼›é¿å…åœ¨é”å†…è°ƒç”¨å¤–éƒ¨ä¸å¯ä¿¡ä»£ç ã€‚

## æ— é”ä¸å¹¶å‘å®¹å™¨

```java
ConcurrentLinkedQueue<Integer> q = new ConcurrentLinkedQueue<>();
q.offer(1); q.poll();
```

è¦ç‚¹ï¼šCAS å¤±è´¥é‡è¯•ã€è‡ªæ—‹å¼€é”€ã€ABA é—®é¢˜ï¼ˆ`AtomicStampedReference`ï¼‰ã€‚

## èƒŒå‹ä¸é™æµ

```
ç”Ÿäº§é€Ÿåº¦ > æ¶ˆè´¹é€Ÿåº¦ â†’ é˜Ÿåˆ—ç§¯å‹ â†’ å»¶è¿Ÿ/å†…å­˜å‹åŠ›
è§£å†³ï¼šé™æµï¼ˆRateLimiter/æ¼æ¡¶ï¼‰ã€æ‹’ç»ç­–ç•¥ã€ä¸¢å¼ƒæ—§ä»»åŠ¡ã€åˆ†çº§é˜Ÿåˆ—
```

## çº¿ç¨‹æ± æ·±åº¦å®è·µ

```java
ThreadPoolExecutor pool = new ThreadPoolExecutor(
  8, 32, 60, TimeUnit.SECONDS,
  new ArrayBlockingQueue<>(2000),
  new ThreadFactoryBuilder().setNameFormat("biz-%d").build(),
  new ThreadPoolExecutor.CallerRunsPolicy()
);
```

ç›‘æ§ï¼šæ´»è·ƒçº¿ç¨‹ã€é˜Ÿåˆ—é•¿åº¦ã€æ‹’ç»æ¬¡æ•°ã€ä»»åŠ¡è€—æ—¶åˆ†å¸ƒï¼ˆJFR/æ—¥å¿—ï¼‰ã€‚

## å¹¶å‘ Bug å›¾è°±

- æ­»é”/æ´»é”/é¥¥é¥¿ï¼›ä¸¢å¤±æ›´æ–°ï¼›å‘å¸ƒä¸é€¸å‡ºï¼›Double-Checked é”™è¯¯å†™æ³•ï¼›
- ä¼ªå…±äº«ï¼šä½¿ç”¨ `@Contended` æˆ–å­—æ®µå¡«å……ï¼›
- ThreadLocal æ³„æ¼ï¼šçº¿ç¨‹æ± å¤ç”¨ä¸‹è®°å¾— removeã€‚

## å®æˆ˜ï¼šå¤šé˜¶æ®µæµæ°´çº¿ï¼ˆPhaserï¼‰

```java
Phaser ph = new Phaser(1);
for (int i=0;i<4;i++){ ph.register(); new Thread(() -> { ph.arriveAndAwaitAdvance(); step2(); ph.arriveAndDeregister(); }).start(); }
ph.arriveAndDeregister();
```

## ä¸‹ä¸€æ­¥

æŒæ¡äº†å¹¶å‘ç¼–ç¨‹é«˜çº§åï¼Œå¯ä»¥ç»§ç»­å­¦ä¹ ï¼š

- [åˆ†å¸ƒå¼ä¸å¾®æœåŠ¡](/java/31-åˆ†å¸ƒå¼ä¸å¾®æœåŠ¡.md) - å­¦ä¹ åˆ†å¸ƒå¼ç³»ç»Ÿ
- [Java é¢è¯•ä¸å·¥ç¨‹èƒ½åŠ›](/java/32-Javaé¢è¯•ä¸å·¥ç¨‹èƒ½åŠ›.md) - æå‡é¢è¯•èƒ½åŠ›

---

<div style="text-align: center; margin-top: 2rem;">
  <p>ğŸ’¡ <strong>æç¤º</strong>ï¼šå¹¶å‘ç¼–ç¨‹æ˜¯ Java å¼€å‘çš„é‡è¦æŠ€èƒ½ï¼Œéœ€è¦æ·±å…¥ç†è§£çº¿ç¨‹å®‰å…¨å’Œé”æœºåˆ¶</p>
</div>
