# ğŸ”„ å¤šçº¿ç¨‹åŸºç¡€

## å¤šçº¿ç¨‹æ¦‚è¿°

å¤šçº¿ç¨‹ï¼ˆMultithreadingï¼‰å…è®¸ç¨‹åºåŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œæé«˜ç¨‹åºçš„å¹¶å‘æ€§å’Œå“åº”æ€§ã€‚

### çº¿ç¨‹ä¸è¿›ç¨‹

- **è¿›ç¨‹**ï¼šç¨‹åºçš„ä¸€æ¬¡æ‰§è¡Œï¼Œæœ‰ç‹¬ç«‹çš„åœ°å€ç©ºé—´
- **çº¿ç¨‹**ï¼šè¿›ç¨‹å†…çš„æ‰§è¡Œå•å…ƒï¼Œå…±äº«è¿›ç¨‹çš„åœ°å€ç©ºé—´

## åˆ›å»ºçº¿ç¨‹

### æ–¹å¼1ï¼šç»§æ‰¿ Thread ç±»

```java
public class MyThread extends Thread {
    @Override
    public void run() {
        for (int i = 0; i < 5; i++) {
            System.out.println("çº¿ç¨‹è¿è¡Œ: " + i);
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}

// ä½¿ç”¨
MyThread thread = new MyThread();
thread.start();
```

### æ–¹å¼2ï¼šå®ç° Runnable æ¥å£

```java
public class MyRunnable implements Runnable {
    @Override
    public void run() {
        for (int i = 0; i < 5; i++) {
            System.out.println("çº¿ç¨‹è¿è¡Œ: " + i);
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}

// ä½¿ç”¨
Thread thread = new Thread(new MyRunnable());
thread.start();
```

### æ–¹å¼3ï¼šLambda è¡¨è¾¾å¼ï¼ˆJava 8+ï¼‰

```java
Thread thread = new Thread(() -> {
    for (int i = 0; i < 5; i++) {
        System.out.println("çº¿ç¨‹è¿è¡Œ: " + i);
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
});
thread.start();
```

## çº¿ç¨‹çŠ¶æ€

### çº¿ç¨‹çŠ¶æ€è½¬æ¢

```
æ–°å»º â†’ å°±ç»ª â†’ è¿è¡Œ â†’ é˜»å¡ â†’ å°±ç»ª â†’ è¿è¡Œ â†’ ç»ˆæ­¢
```

### çº¿ç¨‹çŠ¶æ€æ–¹æ³•

```java
Thread thread = new Thread(() -> {
    // çº¿ç¨‹ä»£ç 
});

// è·å–çŠ¶æ€
Thread.State state = thread.getState();
System.out.println("çº¿ç¨‹çŠ¶æ€: " + state);

// å¯åŠ¨çº¿ç¨‹
thread.start();

// ç­‰å¾…çº¿ç¨‹å®Œæˆ
thread.join();

// ä¸­æ–­çº¿ç¨‹
thread.interrupt();

// æ£€æŸ¥æ˜¯å¦ä¸­æ–­
boolean interrupted = thread.isInterrupted();
```

## çº¿ç¨‹åŒæ­¥

### synchronized å…³é”®å­—

```java
public class Counter {
    private int count = 0;
    
    // åŒæ­¥æ–¹æ³•
    public synchronized void increment() {
        count++;
    }
    
    // åŒæ­¥ä»£ç å—
    public void increment2() {
        synchronized (this) {
            count++;
        }
    }
}
```

### wait å’Œ notify

```java
public class ProducerConsumer {
    private int value;
    private boolean hasValue = false;
    
    public synchronized void produce(int val) {
        while (hasValue) {
            try {
                wait();  // ç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
        value = val;
        hasValue = true;
        notify();  // é€šçŸ¥æ¶ˆè´¹è€…
    }
    
    public synchronized int consume() {
        while (!hasValue) {
            try {
                wait();  // ç­‰å¾…ç”Ÿäº§è€…ç”Ÿäº§
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
        hasValue = false;
        notify();  // é€šçŸ¥ç”Ÿäº§è€…
        return value;
    }
}
```

## å¯è§æ€§ã€æœ‰åºæ€§ä¸åŸå­æ€§ï¼ˆJMM é€Ÿè§ˆï¼‰

- å¯è§æ€§ï¼šä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„å†™å…¥ä½•æ—¶å¯¹å…¶ä»–çº¿ç¨‹å¯è§ï¼ˆ`volatile`/é”ï¼‰ã€‚
- æœ‰åºæ€§ï¼šç¼–è¯‘å™¨ä¸ CPU å…è®¸é‡æ’åºï¼Œä½†éœ€æ»¡è¶³ `happens-before` è§„åˆ™ã€‚
- åŸå­æ€§ï¼šä¸å¯å†åˆ†çš„æ“ä½œï¼Œ`long/double` åœ¨æ—©æœŸ 32 ä½ä¸ŠéåŸå­ï¼ˆç°ä»£å®ç°å·²ä¿è¯ï¼‰ã€‚

### volatile çš„æ­£ç¡®ç”¨æ³•

```java
class StopSignal {
    private volatile boolean stopped = false;
    public void stop() { stopped = true; }
    public void run() {
        while (!stopped) {
            // do work
        }
    }
}
```

- ä¿éšœå¯è§æ€§ä¸ç¦æ­¢ç‰¹å®šåœºæ™¯ä¸‹çš„é‡æ’åºï¼›ä¸ä¿è¯å¤åˆæ“ä½œçš„åŸå­æ€§ã€‚

### æŒ‡ä»¤é‡æ’ä¸ DCL å•ä¾‹

```java
public class Singleton {
    private static volatile Singleton INSTANCE;
    public static Singleton getInstance() {
        if (INSTANCE == null) {
            synchronized (Singleton.class) {
                if (INSTANCE == null) INSTANCE = new Singleton();
            }
        }
        return INSTANCE;
    }
}
```

## é”ä¸å¹¶å‘åŸè¯­

### synchronized çš„å¯¹è±¡é”ä¸ç±»é”

- å®ä¾‹æ–¹æ³•é”çš„æ˜¯ `this`ï¼Œé™æ€æ–¹æ³•é”çš„æ˜¯ `Class` å¯¹è±¡ã€‚
- å°½é‡ç¼©å°åŒæ­¥ä»£ç å—ï¼Œé¿å…æ— è°“ç«äº‰ã€‚

### ReentrantLock ä¸æ¡ä»¶é˜Ÿåˆ—

```java
Lock lock = new ReentrantLock();
Condition notEmpty = lock.newCondition();
Condition notFull = lock.newCondition();
```

- æ”¯æŒå¯ä¸­æ–­ã€å¯å®šæ—¶ã€å…¬å¹³/éå…¬å¹³ã€å¤šä¸ªæ¡ä»¶é˜Ÿåˆ—ã€‚

### è¯»å†™é”ä¸ StampedLockï¼ˆç®€ä»‹ï¼‰

- `ReentrantReadWriteLock`ï¼šè¯»å¤šå†™å°‘çš„åœºæ™¯æœ‰æ•ˆã€‚
- `StampedLock`ï¼šæ”¯æŒä¹è§‚è¯»ï¼Œéœ€æ³¨æ„ä¸­æ–­ä¸å¯é‡å…¥é™åˆ¶ã€‚

## çº¿ç¨‹é—´åä½œæ¨¡å¼

### ç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼ˆBlockingQueueï¼‰

```java
BlockingQueue<Integer> q = new ArrayBlockingQueue<>(100);
// ç”Ÿäº§è€…ï¼šq.put(x); æ¶ˆè´¹è€…ï¼šq.take();
```

### Future/CompletableFuture æ¦‚è§ˆ

```java
CompletableFuture<Integer> f = CompletableFuture.supplyAsync(() -> 42)
    .thenApply(x -> x + 1)
    .exceptionally(ex -> -1);
```

## çº¿ç¨‹æ± å®è·µ

### ä¸ºä»€ä¹ˆä¼˜å…ˆä½¿ç”¨çº¿ç¨‹æ± 

- å¤ç”¨çº¿ç¨‹é™ä½åˆ›å»ºé”€æ¯æˆæœ¬ï¼›å¯æ§çš„å¹¶å‘åº¦ï¼›å¯è§‚æµ‹ä¸ç›‘æ§ã€‚

### æ­£ç¡®åˆ›å»ºçº¿ç¨‹æ± ï¼ˆé¿å… Executors å·¥å‚é»˜è®¤é™·é˜±ï¼‰

```java
ThreadPoolExecutor pool = new ThreadPoolExecutor(
    8, 16,
    60, TimeUnit.SECONDS,
    new ArrayBlockingQueue<>(1000),
    new ThreadFactoryBuilder().setNameFormat("biz-pool-%d").build(),
    new ThreadPoolExecutor.CallerRunsPolicy()
);
```

- è‡ªå®šä¹‰é˜Ÿåˆ—ä¸æ‹’ç»ç­–ç•¥ï¼›å‘½åçº¿ç¨‹ä¾¿äºå®šä½ï¼›å…³æ³¨é¥±å’Œæ—¶è¡Œä¸ºã€‚

### çº¿ç¨‹æ± å‚æ•°è°ƒä¼˜æŒ‡å¼•

- è®¡ç®—å¯†é›†ï¼šæ ¸å¿ƒçº¿ç¨‹â‰ˆCPU æ ¸å¿ƒæ•°æˆ–ç•¥å¤šï¼›IO å¯†é›†ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°Ã—(1+å¹³å‡é˜»å¡ç³»æ•°)ã€‚
- ä½¿ç”¨ç›‘æ§ï¼ˆJFR/Arthas/æ—¥å¿—ï¼‰è§‚å¯Ÿé˜Ÿåˆ—é•¿åº¦ã€æ´»è·ƒçº¿ç¨‹ä¸ä»»åŠ¡è€—æ—¶ã€‚

## å¸¸è§å¹¶å‘ Bug ä¸å®šä½

- æ­»é”ï¼šå¾ªç¯ç­‰å¾… + äº’æ–¥ + ä¸å¯å‰¥å¤º + å æœ‰ä¸”ç­‰å¾…ã€‚

```java
// ä½¿ç”¨ jstack <pid> æŸ¥çœ‹ FOUND ONE JAVA-LEVEL DEADLOCK
```

- æ´»é”ï¼šçº¿ç¨‹ä¸æ–­é‡è¯•äº’ç›¸è°¦è®©ä½†æ— è¿›å±•ã€‚
- é¥¥é¥¿ï¼šä½ä¼˜å…ˆçº§çº¿ç¨‹é•¿æœŸå¾—ä¸åˆ°è°ƒåº¦ï¼ˆä¸å»ºè®®ä¿®æ”¹çº¿ç¨‹ä¼˜å…ˆçº§ï¼‰ã€‚

## ThreadLocal ä¸å†…å­˜æ³„æ¼

- åœ¨çº¿ç¨‹æ± å¤ç”¨ä¸‹ï¼Œ`ThreadLocal` å€¼éœ€åŠæ—¶æ¸…ç†ï¼š`try { set } finally { remove }`ã€‚
- é¿å…åœ¨å¤§å¯¹è±¡/è¿æ¥ä¸Šé•¿æœŸæŒæœ‰å¼•ç”¨ã€‚

## False Sharingï¼ˆä¼ªå…±äº«ï¼‰

- å¤šçº¿ç¨‹å†™å…¥ç›¸é‚»å†…å­˜å¯¼è‡´åŒä¸€ç¼“å­˜è¡Œåå¤å¤±æ•ˆã€‚
- é€šè¿‡ `@Contended`ï¼ˆéœ€ `-XX:-RestrictContended`ï¼‰æˆ–æ‰‹åŠ¨å¡«å……é¿å…ã€‚

## ç»ƒä¹ ä¸æ€è€ƒ

1. ç”¨ `BlockingQueue` å®ç°å¤šç”Ÿäº§è€…-å¤šæ¶ˆè´¹è€…ï¼Œç»Ÿè®¡ååä¸å»¶è¿Ÿã€‚
2. å°† `synchronized` æ”¹ä¸º `ReentrantLock`ï¼Œåœ¨è¶…æ—¶ä¸å¯ä¸­æ–­åœºæ™¯æ¯”è¾ƒè¡¨ç°ã€‚
3. ä½¿ç”¨ `CompletableFuture` æ”¹é€ ä¸²è¡Œè°ƒç”¨ä¸ºå¹¶è¡Œèšåˆã€‚

## å®Œæ•´ç¤ºä¾‹

```java
public class ThreadExample {
    public static void main(String[] args) {
        // åˆ›å»ºçº¿ç¨‹
        Thread thread1 = new Thread(() -> {
            for (int i = 0; i < 5; i++) {
                System.out.println("çº¿ç¨‹1: " + i);
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        });
        
        Thread thread2 = new Thread(() -> {
            for (int i = 0; i < 5; i++) {
                System.out.println("çº¿ç¨‹2: " + i);
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        });
        
        // å¯åŠ¨çº¿ç¨‹
        thread1.start();
        thread2.start();
        
        // ç­‰å¾…çº¿ç¨‹å®Œæˆ
        try {
            thread1.join();
            thread2.join();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        
        System.out.println("æ‰€æœ‰çº¿ç¨‹å®Œæˆ");
    }
}
```

## ä¸‹ä¸€æ­¥

æŒæ¡äº†å¤šçº¿ç¨‹åŸºç¡€åï¼Œå¯ä»¥ç»§ç»­å­¦ä¹ ï¼š

- [å¹¶å‘å·¥å…·ç±»](/java/19-å¹¶å‘å·¥å…·ç±».md) - å­¦ä¹ å¹¶å‘å·¥å…·çš„ä½¿ç”¨
- [JVM åŸºç¡€](/java/20-JVMåŸºç¡€.md) - å­¦ä¹  JVM åŸç†

---

<div style="text-align: center; margin-top: 2rem;">
  <p>ğŸ’¡ <strong>æç¤º</strong>ï¼šå¤šçº¿ç¨‹ç¼–ç¨‹å¯ä»¥æé«˜ç¨‹åºæ€§èƒ½ï¼Œä½†éœ€è¦æ³¨æ„çº¿ç¨‹å®‰å…¨é—®é¢˜</p>
</div>
