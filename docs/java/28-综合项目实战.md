# ğŸš€ ç»¼åˆé¡¹ç›®å®æˆ˜

## é¡¹ç›®å®æˆ˜æ¦‚è¿°

é€šè¿‡å®é™…é¡¹ç›®ç»ƒä¹ ï¼Œç»¼åˆè¿ç”¨æ‰€å­¦çŸ¥è¯†ã€‚

æœ¬ç« é‡‡ç”¨â€œç”µå•†ç®€åŒ–åŸŸâ€ä½œä¸ºç»Ÿä¸€æ¡ˆä¾‹ï¼šç”¨æˆ·ã€å•†å“ã€è®¢å•ã€æ”¯ä»˜ã€‚åŒ…å«é¢†åŸŸå»ºæ¨¡ã€æ¥å£å¥‘çº¦ã€æ•°æ®åº“è®¾è®¡ã€åˆ†å±‚æ¶æ„ã€æµ‹è¯•ä¸CIã€è§‚æµ‹ä¸éƒ¨ç½²ã€‚

```
ç”¨æˆ·ä¸‹å•ä¸»æµç¨‹ï¼ˆé«˜å±‚ï¼‰ï¼š
Client â†’ API ç½‘å…³ â†’ è®¢å•æœåŠ¡ï¼ˆæ ¡éªŒ/å®šä»·/åº“å­˜é¢„å ï¼‰â†’ æ”¯ä»˜æœåŠ¡ï¼ˆä¸‹å•/å›è°ƒï¼‰â†’ è®¢å•æœåŠ¡ï¼ˆçŠ¶æ€æµè½¬ï¼‰
```

## é¡¹ç›®ç¤ºä¾‹

### ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ

```java
// ç”¨æˆ·å®ä½“
@Entity
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String name;
    private String email;
    
    // getter/setter
}

// ç”¨æˆ·æœåŠ¡
@Service
public class UserService {
    @Autowired
    private UserRepository userRepository;
    
    public User createUser(User user) {
        return userRepository.save(user);
    }
    
    public User getUser(Long id) {
        return userRepository.findById(id)
            .orElseThrow(() -> new UserNotFoundException(id));
    }
    
    public List<User> getAllUsers() {
        return userRepository.findAll();
    }
    
    public void deleteUser(Long id) {
        userRepository.deleteById(id);
    }
}
```

### è®¢å•ç”¨ä¾‹ä¸çŠ¶æ€æœº

```
[INIT] --create--> [PENDING_PAY] --pay_ok--> [PAID] --ship--> [SHIPPED] --confirm--> [DONE]
                                  â””--pay_fail/cancel--> [CANCELED]
```

### REST æ¥å£å¥‘çº¦ï¼ˆç‰‡æ®µï¼‰

```http
POST /api/orders
{ "userId": 1, "items": [{"sku":"SKU123","qty":2}] }

200 OK
{ "orderId": 1001, "status": "PENDING_PAY", "amount": 19900 }
```

```http
POST /api/payments
{ "orderId":1001, "channel":"WECHAT" }
â†’ 302 Redirect to pay_url
```

## é¡¹ç›®ç»“æ„

```
project/
â”œâ”€â”€ src/main/java/
â”‚   â”œâ”€â”€ controller/
â”‚   â”œâ”€â”€ service/
â”‚   â”œâ”€â”€ repository/
â”‚   â”œâ”€â”€ entity/
â”‚   â””â”€â”€ config/
â”œâ”€â”€ src/main/resources/
â”‚   â”œâ”€â”€ application.properties
â”‚   â””â”€â”€ application.yml
â””â”€â”€ pom.xml
```

æ¨èæŒ‰â€œåˆ†å±‚ + æœ‰ç•Œä¸Šä¸‹æ–‡â€ç»„ç»‡ï¼š`user-domain`ã€`product-domain`ã€`order-service`ã€`payment-service`ã€`api-gateway`ã€‚

## æ•°æ®åº“è®¾è®¡ï¼ˆæ ¸å¿ƒè¡¨ï¼‰

```
t_user(id, name, email, created_at)
t_product(id, sku, name, price, stock)
t_order(id, user_id, amount, status, created_at)
t_order_item(id, order_id, product_id, sku, price, qty)
t_payment(id, order_id, channel, amount, status, trade_no)
```

ç´¢å¼•å»ºè®®ï¼š
- `t_product.sku` å”¯ä¸€ï¼›`t_order.user_id`ã€`t_order.created_at` ç»„åˆç´¢å¼•ï¼›
- `t_order_item.order_id`ï¼›`t_payment.order_id`ã€‚

## æ ¸å¿ƒæµç¨‹ï¼ˆé¡ºåºå›¾ï¼‰

```
Client â†’ API â†’ OrderSvc:create
OrderSvc â†’ ProductSvc: checkStock+price
OrderSvc â†’ OrderRepo: save(PENDING_PAY)
Client â†’ PaySvc:create
PayGateway â†’ PaySvc: callback(OK)
PaySvc â†’ OrderSvc: markPaid
```

## å…³é”®å®ç°ç‰‡æ®µ

```java
// é¢†åŸŸæœåŠ¡ï¼šè®¢å•åˆ›å»ºï¼ˆæ ¡éªŒ/å®šä»·/åº“å­˜é¢„å ï¼‰
@Transactional
public Order create(CreateOrder cmd){
  Money amount = pricing(cmd.items());
  preReserveStock(cmd.items());
  return repo.save(Order.pending(cmd.userId(), amount));
}
```

```java
// é˜²æ­¢è¶…å–çš„åº“å­˜é¢„å ï¼ˆç¤ºä¾‹ï¼šæ‚²è§‚é”/ä¹è§‚é”äºŒé€‰ä¸€ï¼‰
int updated = jdbc.update("update t_product set stock=stock-? where sku=? and stock>=?", qty, sku, qty);
if (updated==0) throw new BusinessException("åº“å­˜ä¸è¶³");
```

```java
// æ”¯ä»˜å›è°ƒå¹‚ç­‰å¤„ç†
@Transactional
public void onPayCallback(String orderId, String tradeNo){
  if (payRepo.existsByTradeNo(tradeNo)) return; // å¹‚ç­‰
  payRepo.save(...);
  orderRepo.markPaid(orderId);
}
```

## æµ‹è¯•ä¸ CI

```
æµ‹è¯•é‡‘å­—å¡”ï¼šå•å…ƒï¼ˆæœ€å¤šï¼‰â†’ é›†æˆï¼ˆRepo/å¤–éƒ¨ä¾èµ–ï¼‰â†’ E2Eï¼ˆå…³é”®é“¾è·¯ï¼‰
```

```java
@DataJpaTest
class OrderRepoTest { /* repository é›†æˆæµ‹è¯• */ }

@SpringBootTest
@AutoConfigureMockMvc
class OrderApiTest { /* API å±‚é›†æˆæµ‹è¯• */ }
```

CI æ­¥éª¤ï¼šç¼–è¯‘ â†’ å•å…ƒæµ‹è¯• â†’ é›†æˆæµ‹è¯•ï¼ˆå®¹å™¨åŒ–ä¾èµ–ï¼Œç”¨ Testcontainersï¼‰â†’ ç”Ÿæˆè¦†ç›–ç‡ â†’ æ„å»ºé•œåƒã€‚

## å¯è§‚æµ‹æ€§ï¼ˆæ—¥å¿—/æŒ‡æ ‡/è¿½è¸ªï¼‰

```
æ—¥å¿—ï¼šç»“æ„åŒ–ï¼ˆJSONï¼‰
æŒ‡æ ‡ï¼šQPSã€P95 å»¶è¿Ÿã€é”™è¯¯ç‡ã€åº“å­˜å¤±è´¥ç‡ã€æ”¯ä»˜å›è°ƒå¹‚ç­‰å‘½ä¸­ç‡
è¿½è¸ªï¼šTraceId è·¨æœåŠ¡ä¼ é€’ï¼ˆç½‘å…³æ³¨å…¥ï¼‰
```

## éƒ¨ç½²ä¸é…ç½®

```
å¤šé˜¶æ®µé•œåƒï¼š
1) æ„å»ºé•œåƒï¼ˆmvn -T 1C -DskipTests packageï¼‰
2) è¿è¡Œé•œåƒï¼ˆjlink ç²¾ç®€ JREï¼Œå¯é€‰ï¼‰
æ»šåŠ¨å‘å¸ƒï¼šå¥åº·æ£€æŸ¥ /readiness /liveness
```

```yaml
# Kubernetes ç‰‡æ®µ
resources:
  limits:
    cpu: "1"
    memory: "512Mi"
env:
  - name: JVM_OPTS
    value: "-Xms512m -Xmx512m -XX:+UseG1GC -Xlog:gc"
```

## ä¸‹ä¸€æ­¥

å®Œæˆäº†ç»¼åˆé¡¹ç›®å®æˆ˜åï¼Œå¯ä»¥ç»§ç»­å­¦ä¹ ï¼š

- [JVM æ·±å…¥ä¸æ€§èƒ½è°ƒä¼˜](/java/29-JVMæ·±å…¥ä¸æ€§èƒ½è°ƒä¼˜.md) - æ·±å…¥å­¦ä¹  JVM
- [å¹¶å‘ç¼–ç¨‹é«˜çº§](/java/30-å¹¶å‘ç¼–ç¨‹é«˜çº§.md) - æ·±å…¥å­¦ä¹ å¹¶å‘ç¼–ç¨‹

---

<div style="text-align: center; margin-top: 2rem;">
  <p>ğŸ’¡ <strong>æç¤º</strong>ï¼šé€šè¿‡å®é™…é¡¹ç›®ç»ƒä¹ ï¼Œå¯ä»¥æ›´å¥½åœ°ç†è§£å’Œåº”ç”¨æ‰€å­¦çŸ¥è¯†</p>
</div>
