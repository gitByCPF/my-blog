# ğŸ“¦ æ¨¡å—åŒ–ä¸åŒ…ç®¡ç†ï¼ˆJPMSã€Mavenã€Gradle æ·±å…¥ï¼‰

æœ¬ç« è¦†ç›– Java 9 å¼•å…¥çš„æ¨¡å—ç³»ç»Ÿï¼ˆJPMSï¼‰çš„åŠ¨æœºã€æ ¸å¿ƒæ¦‚å¿µã€å®è·µæ¨¡å¼ä¸è¿ç§»ç­–ç•¥ï¼Œå¹¶ç³»ç»Ÿæ¢³ç† Maven/Gradle çš„ä¾èµ–ç®¡ç†ã€ç‰ˆæœ¬å¯¹é½ä¸å†²çªæ¶ˆè§£æ–¹æ³•ï¼Œå¸®åŠ©ä½ æ„å»ºç¨³å®šã€å¯ç»´æŠ¤çš„å¤§ä¸­å‹ Java é¡¹ç›®ã€‚

## 1. ä¸ºä»€ä¹ˆéœ€è¦æ¨¡å—åŒ–ï¼ˆJPMSï¼‰

- æ˜ç¡®çš„è¾¹ç•Œä¸å°è£…ï¼šåªå¯¼å‡ºéœ€è¦è¢«ä½¿ç”¨çš„ API åŒ…ï¼Œéšè—å†…éƒ¨å®ç°ã€‚
- å‡å°‘ç±»è·¯å¾„åœ°ç‹±ï¼ˆClass-Path Hellï¼‰ï¼šå¯å£°æ˜ä¾èµ–å…³ç³»ã€æ£€æµ‹å¾ªç¯ä¾èµ–ä¸ç¼ºå¤±ã€‚
- æ›´å¥½çš„å¯åŠ¨ä¸è¿è¡Œæ—¶å›¾è°±ï¼šæ”¯æŒ `jlink` å®šåˆ¶æœ€å°è¿è¡Œæ—¶é•œåƒã€‚
- å®‰å…¨ä¸å¯ç»´æŠ¤ï¼š`opens`/`exports` åŒºåˆ†åå°„å¯è§æ€§ï¼Œé™åˆ¶éšæ„è®¿é—®ã€‚

## 2. æ¨¡å—åŸºç¡€ï¼šmodule-info.java

### 2.1 åŸºæœ¬è¯­æ³•

```java
module com.example.app {
    requires java.base;       // éšå¼ä¾èµ–ï¼Œå¯çœç•¥
    requires java.sql;        // å£°æ˜ä¾èµ–

    exports com.example.app.api;        // å¯¼å‡º API åŒ…ä¾›å¤–éƒ¨ä½¿ç”¨
    exports com.example.app.util;       // å¯å¯¼å‡ºå¤šä¸ªåŒ…

    // ä»…å¯¹ç‰¹å®šæ¨¡å—å¼€æ”¾åå°„ï¼ˆJPA/Hibernate ç­‰å¸¸è§ï¼‰
    opens com.example.app.entity to org.hibernate.orm.core;

    // æœåŠ¡æä¾›ä¸æ¶ˆè´¹ï¼ˆSPIï¼‰
    uses com.example.spi.PaymentService;
    provides com.example.spi.PaymentService
        with com.example.impl.WechatPaymentService;
}
```

### 2.2 é‡è¦å…³é”®å­—

- `exports`ï¼šç¼–è¯‘æœŸä¸è¿è¡ŒæœŸå‡å¯¹å¤–å¯è§ï¼ˆç¼–è¯‘ä¾èµ– & è®¿é—®ï¼‰ã€‚
- `opens`ï¼šä»…åœ¨è¿è¡ŒæœŸå¯¹åå°„å¼€æ”¾ï¼ˆä¸æä¾›ç¼–è¯‘æœŸå¯è§æ€§ï¼‰ã€‚
- `requires transitive`ï¼šä¼ é€’ä¾èµ–ï¼ŒAâ†’Bï¼ˆtransitiveï¼‰ï¼Œåˆ™ä¾èµ– A çš„æ¨¡å—è‡ªåŠ¨è¯»å– Bã€‚
- `requires static`ï¼šä»…ç¼–è¯‘æœŸä¾èµ–ï¼Œè¿è¡Œæ—¶å¯é€‰ï¼ˆå¸¸ç”¨äºå¯é€‰åŠŸèƒ½ï¼‰ã€‚

### 2.3 å¯è¯»æ€§ä¸å¯è®¿é—®æ€§

- æ¨¡å—å›¾å†³å®šâ€œå¯è¯»æ€§â€ï¼ˆreadabilityï¼‰ï¼Œ`exports`/`opens` å†³å®šâ€œå¯è®¿é—®æ€§â€ï¼ˆaccessibilityï¼‰ã€‚
- é€šè¿‡ `java --describe-module com.example.app` æŸ¥çœ‹æ¨¡å—ä¿¡æ¯ã€‚

## 3. æ¨¡å—åŒ–å¸¸è§ç»“æ„ä¸é™·é˜±

### 3.1 è‡ªåŠ¨æ¨¡å—ä¸æœªå‘½åæ¨¡å—

- è‡ªåŠ¨æ¨¡å—ï¼šå°†ç±»è·¯å¾„ä¸Šçš„ JAR æ”¾åˆ°æ¨¡å—è·¯å¾„ï¼ˆ--module-pathï¼‰ï¼Œå…¶åç§°æ¥æºäº JAR æ–‡ä»¶åã€‚
- æœªå‘½åæ¨¡å—ï¼šä»åœ¨ç±»è·¯å¾„ï¼ˆ-classpathï¼‰ä¸Šçš„ä»£ç ï¼Œè§†ä¸ºæœªå‘½åæ¨¡å—ï¼Œèƒ½è¯»å–æ‰€æœ‰å‘½åæ¨¡å—ï¼Œä½†è¢«å¼ºå°è£…æ¨¡å—è¯»å–å—é™ã€‚

å»ºè®®å°½é‡è¿ç§»åˆ°â€œå…¨æ¨¡å—è·¯å¾„â€ï¼Œå‡å°‘è‡ªåŠ¨æ¨¡å—çš„ä¸å¯é¢„æµ‹æ€§ã€‚

### 3.2 Split Packageï¼ˆåŒ…æ‹†åˆ†ï¼‰é—®é¢˜

- JPMS ä¸å…è®¸åŒååŒ…æ¥è‡ªå¤šä¸ªæ¨¡å—ï¼ˆä¸ OSGi ç±»ä¼¼ï¼‰ï¼Œé¡»åˆå¹¶æˆ–é‡å‘½åã€‚
- å…¸å‹äºå¤šæ¨¡å—é¡¹ç›®å¤ç”¨ `com.example.common` åŒ…æ—¶éœ€å°å¿ƒã€‚

### 3.3 åå°„æ¡†æ¶å…¼å®¹

- JPA/Hibernateã€Jacksonã€Spring åœ¨è¿è¡ŒæœŸéœ€è¦åå°„è®¿é—®éå…¬å¼€æˆå‘˜ï¼Œéœ€åœ¨ `module-info.java` ä½¿ç”¨ `opens` æˆ– `open module`ï¼ˆå¯¹æ‰€æœ‰åŒ…å¼€æ”¾åå°„ï¼Œæä¸æ¨èï¼‰ã€‚

## 4. æ¨¡å—å·¥å…·é“¾ï¼šç¼–è¯‘ã€è¿è¡Œã€æ‰“åŒ…

### 4.1 ç¼–è¯‘ä¸è¿è¡Œ

```bash
# ç¼–è¯‘ï¼ˆæ¨¡å—è·¯å¾„ï¼‰
javac --module-path libs -d out $(find src -name "*.java")

# è¿è¡Œ
java  --module-path out:libs --module com.example.app/com.example.app.Main
```

### 4.2 jlink å®šåˆ¶è¿è¡Œæ—¶

```bash
jlink \
  --module-path $JAVA_HOME/jmods:out \
  --add-modules com.example.app \
  --output runtime-image \
  --strip-debug --compress=2 --no-header-files --no-man-pages
```

ç”Ÿæˆä»…åŒ…å«æ‰€éœ€æ¨¡å—çš„ç²¾ç®€è¿è¡Œæ—¶ï¼Œæ˜¾è‘—é™ä½é•œåƒå¤§å°ä¸å¯åŠ¨æ—¶é—´ã€‚

### 4.3 jmod ä¸å¤šæ¨¡å—å¸ƒå±€

- `jmod` å¯å°è£…æœ¬åœ°åº“ä¸é…ç½®ï¼›å¤šæ¨¡å—é¡¹ç›®å»ºè®®ç»Ÿä¸€ `src/<module>/` ç›®å½•ç»“æ„ã€‚

## 5. ä¸ä¸»æµæ¡†æ¶åä½œï¼ˆSpringã€Hibernateã€Jacksonï¼‰

### 5.1 Spring

- Spring 6+/Boot 3+ åŸºäº Jakarta EE å‘½åç©ºé—´ï¼Œæ¨¡å—å…¼å®¹æ›´å¥½ã€‚
- å¯¹åå°„è®¿é—® Bean éœ€è¦ï¼š

```java
module com.example.app {
    opens com.example.app.config to spring.core; // ä»…å¯¹ Spring åå°„å¼€æ”¾
    opens com.example.app.bean   to spring.beans, spring.core;
}
```

### 5.2 JPA/Hibernate

```java
module com.example.app {
    opens com.example.app.entity to org.hibernate.orm.core;
}
```

### 5.3 Jackson

```java
module com.example.app {
    opens com.example.app.dto to com.fasterxml.jackson.databind;
}
```

## 6. è¿ç§»ç­–ç•¥ï¼šä»ç±»è·¯å¾„åˆ°æ¨¡å—è·¯å¾„

1. å…ˆæ¸…ç† Split Packageï¼Œå½’å¹¶å…±äº«åŒ…åˆ°ç‹¬ç«‹æ¨¡å—ã€‚
2. ä¸ºæ¯ä¸ªæ¨¡å—è¡¥å…… `module-info.java`ï¼Œæ˜ç¡® `exports` ä¸ `requires`ã€‚
3. æ£€æŸ¥åå°„éœ€æ±‚ï¼ŒæŒ‰éœ€ `opens` åˆ°å…·ä½“æ¨¡å—ï¼Œé¿å… `open module`ã€‚
4. é€æ­¥å°†ä¾èµ–ä»ç±»è·¯å¾„è¿è‡³æ¨¡å—è·¯å¾„ï¼Œå‡å°‘è‡ªåŠ¨æ¨¡å—ã€‚
5. æœ€åä½¿ç”¨ `jlink` ä¼˜åŒ–åˆ†å‘é•œåƒä¸å¯åŠ¨ã€‚

## 7. Maven ä¾èµ–ç®¡ç†ï¼ˆæ·±å…¥ï¼‰

### 7.1 ä¾èµ–èŒƒå›´ä¸ä¼ é€’

- `compile`ï¼ˆé»˜è®¤ï¼‰ã€`provided`ã€`runtime`ã€`test`ã€`system`ã€`import`ã€‚
- ä¼ é€’ä¾èµ–é€šè¿‡æœ€è¿‘ä¼˜å…ˆä¸æœ€çŸ­è·¯å¾„åŸåˆ™è§£æã€‚

### 7.2 ç‰ˆæœ¬å¯¹é½ä¸ BOMï¼ˆBill of Materialsï¼‰

```xml
<dependencyManagement>
  <dependencies>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-dependencies</artifactId>
      <version>3.3.0</version>
      <type>pom</type>
      <scope>import</scope>
    </dependency>
  </dependencies>
</dependencyManagement>
```

- ä¸Šè¿°æ–¹å¼ç»Ÿä¸€ç®¡ç†ç‰ˆæœ¬ï¼Œå­ä¾èµ–æ— éœ€æ˜¾å¼ versionï¼Œé¿å…å†²çªã€‚

### 7.3 ä¾èµ–å†²çªä¸æ’é™¤

```xml
<dependencies>
  <dependency>
    <groupId>io.projectreactor</groupId>
    <artifactId>reactor-core</artifactId>
    <exclusions>
      <exclusion>
        <groupId>org.reactivestreams</groupId>
        <artifactId>reactive-streams</artifactId>
      </exclusion>
    </exclusions>
  </dependency>
</dependencies>
```

### 7.4 å¯é‡å¤æ„å»ºä¸é”å®š

- ä½¿ç”¨ Maven Resolverã€`maven-dependency-plugin` ç”Ÿæˆæ ‘ï¼Œç»“åˆç§æœ‰ä»“åº“é”å®šç‰ˆæœ¬ã€‚

### 7.5 å¤šæ¨¡å— Maven ä¸ JPMS ååŒ

- æ¯ä¸ª Maven æ¨¡å—å¯¹æ ‡ä¸€ä¸ª Java æ¨¡å—ï¼›ä½¿ç”¨ `maven-compiler-plugin` è®¾ç½® `--release` ä¸ `--module-path`ã€‚

```xml
<plugin>
  <groupId>org.apache.maven.plugins</groupId>
  <artifactId>maven-compiler-plugin</artifactId>
  <version>3.11.0</version>
  <configuration>
    <release>17</release>
    <compilerArgs>
      <arg>--module-path</arg>
      <arg>${project.build.outputDirectory}</arg>
    </compilerArgs>
  </configuration>
</plugin>
```

## 8. Gradle ä¾èµ–ç®¡ç†ï¼ˆæ·±å…¥ï¼‰

### 8.1 é…ç½®ä¸ä¾èµ–èŒƒå›´

- å¸¸è§é…ç½®ï¼š`implementation`ã€`api`ã€`compileOnly`ã€`runtimeOnly`ã€`testImplementation`ã€‚
- `api` ä¼šå°†ä¾èµ–æš´éœ²ç»™ä¸‹æ¸¸æ¨¡å—ï¼ˆç±»ä¼¼ `requires transitive`ï¼‰ï¼Œ`implementation` ä¸ä¼šã€‚

### 8.2 ç‰ˆæœ¬å¯¹é½ä¸å¹³å°ï¼ˆplatformï¼‰

```gradle
dependencies {
    implementation platform('org.springframework.boot:spring-boot-dependencies:3.3.0')
    implementation 'org.springframework.boot:spring-boot-starter-web'
}
```

### 8.3 ä¾èµ–è§£æç­–ç•¥ä¸é”å®š

```gradle
configurations.all {
    resolutionStrategy {
        failOnVersionConflict()
        force 'com.fasterxml.jackson.core:jackson-databind:2.17.1'
    }
}

dependencyLocking {
    lockAllConfigurations()
}
```

### 8.4 JPMS ä¸ Gradle

- ä½¿ç”¨ `modularity` æ’ä»¶æˆ–åœ¨ `tasks.compileJava` ä¸­æ·»åŠ  `--module-path`ï¼›å¤šæ¨¡å—å·¥ç¨‹å¯å€ŸåŠ© `java-library` æ’ä»¶åŒºåˆ† `api` ä¸ `implementation`ã€‚

## 9. æ‰“åŒ…ä¸åˆ†å‘

### 9.1 å¯æ‰§è¡Œ JARï¼ˆfat/uber JARï¼‰ä¸æ¨¡å—åŒ–

- `spring-boot-maven-plugin`/`shadowJar` æ‰“åŒ… fat JAR ä¾¿æ·ï¼Œä½†ä¸ JPMS åŒäº²å§”æ´¾ä¸åŒ…ç»“æ„å¯èƒ½å†²çªã€‚
- æ¨¡å—åŒ–é¡¹ç›®ç”Ÿäº§æ¨èï¼šå¸¸è§„åˆ†å±‚é•œåƒ + `jlink` ç²¾ç®€ JREï¼Œæˆ–ä½¿ç”¨å®¹å™¨é•œåƒå¤šé˜¶æ®µæ„å»ºã€‚

### 9.2 å®¹å™¨ä¸é•œåƒä½“ç§¯ä¼˜åŒ–

- JDK 17 alpine åŸºç¡€é•œåƒ + `jlink` è¾“å‡ºçš„è‡ªå®šä¹‰ runtimeï¼Œå¯æ˜¾è‘—å‡å°é•œåƒä½“ç§¯ä¸å†·å¯åŠ¨æ—¶é—´ã€‚

## 10. å®æˆ˜ï¼šä»ä¼ ç»Ÿå¤šæ¨¡å—åˆ° JPMS çš„æœ€å°æ”¹é€ 

1. ä¸º `common`ã€`domain`ã€`app` ä¸‰ä¸ª Maven æ¨¡å—æ·»åŠ  `module-info.java`ï¼š

```java
// common æ¨¡å—
module com.example.common {
    exports com.example.common.util;
}

// domain æ¨¡å—
module com.example.domain {
    requires transitive com.example.common; // ä¸‹æ¸¸è‡ªåŠ¨å¯è¯» common
    exports com.example.domain.model;
    opens com.example.domain.entity to org.hibernate.orm.core;
}

// app æ¨¡å—
module com.example.app {
    requires com.example.domain; // é€šè¿‡ domain é—´æ¥è·å¾— common
    requires spring.context;
    opens com.example.app.config to spring.core, spring.beans;
}
```

2. ä¿®å¤ Split Packageï¼Œå°†é‡å¤åŒ…åˆå¹¶åˆ° `common`ã€‚
3. å¯¹åå°„éœ€æ±‚æœ€å°åŒ– `opens` èŒƒå›´åˆ°å…·ä½“åŒ…ä¸æ¨¡å—ã€‚
4. ä½¿ç”¨ `mvn -DskipTests package` éªŒè¯ï¼Œå†åˆ‡æ¢ `--module-path` è¿è¡Œã€‚
5. æœ€åå¼•å…¥ `jlink` ç”Ÿæˆè¿è¡Œæ—¶é•œåƒä¾›ç”Ÿäº§åˆ†å‘ã€‚

## 11. å¸¸è§é—®é¢˜ä¸æ’æŸ¥

- `java.lang.LayerInstantiationException`ï¼šæ¨¡å—å±‚åŠ è½½å†²çªï¼Œæ£€æŸ¥æ¨¡å—è·¯å¾„ä¸ç‰ˆæœ¬ã€‚
- `java.lang.IllegalAccessError`ï¼šæœªå¯¼å‡º/æœªå¼€æ”¾çš„åŒ…è¢«è®¿é—®æˆ–åå°„ã€‚
- æœåŠ¡åŠ è½½å¤±è´¥ï¼ˆSPIï¼‰ï¼šå¿˜è®°åœ¨ `module-info.java` ä¸­ `uses`/`provides`ã€‚
- Split Packageï¼šåˆå¹¶æˆ–é‡å‘½åï¼Œé¿å…åŒåŒ…å¤šæ¨¡å—ã€‚

## 12. æœ€ä½³å®è·µæ¸…å•

- å†…èšï¼šä¸€ä¸ª Maven æ¨¡å—å¯¹åº”ä¸€ä¸ª Java æ¨¡å—ï¼›å…¬å…±åŒ…å•ç‹¬æ¨¡å—åŒ–ã€‚
- æœ€å°æš´éœ²åŸåˆ™ï¼š`exports` åªå¯¼å‡º API åŒ…ï¼›è¿è¡ŒæœŸåå°„ç”¨ `opens` ç²¾å‡†æˆæƒã€‚
- ç»Ÿä¸€ç‰ˆæœ¬ï¼šMaven BOM æˆ– Gradle platform å¯¹é½ï¼›é”å®šä¾èµ–é¿å…æ¼‚ç§»ã€‚
- æ„å»ºå¯å¤åˆ¶ï¼šæœ¬åœ°/CI ä½¿ç”¨ç›¸åŒä»“åº“ä¸é”å®šç­–ç•¥ï¼›äº§ç‰©å¯è¿½æº¯ã€‚
- åˆ†å‘ä¼˜åŒ–ï¼šç»“åˆ `jlink` ä¸ç²¾ç®€é•œåƒï¼Œç¼©çŸ­å†·å¯åŠ¨ã€æå‡å¯è§‚æµ‹æ€§ã€‚

## 13. å‚è€ƒé…ç½®æ¨¡æ¿

### 13.1 Mavenï¼ˆç‰‡æ®µï¼‰

```xml
<properties>
  <maven.compiler.release>17</maven.compiler.release>
</properties>

<build>
  <plugins>
    <plugin>
      <groupId>org.apache.maven.plugins</groupId>
      <artifactId>maven-compiler-plugin</artifactId>
      <version>3.11.0</version>
      <configuration>
        <release>${maven.compiler.release}</release>
      </configuration>
    </plugin>
  </plugins>
  <pluginManagement>
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-dependency-plugin</artifactId>
        <version>3.6.1</version>
      </plugin>
    </plugins>
  </pluginManagement>
</build>
```

### 13.2 Gradleï¼ˆç‰‡æ®µï¼‰

```gradle
plugins {
    id 'java-library'
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(17)
    }
}

dependencies {
    implementation platform('org.springframework.boot:spring-boot-dependencies:3.3.0')
    api 'com.fasterxml.jackson.core:jackson-annotations'
    implementation 'com.fasterxml.jackson.core:jackson-databind'
}
```

---

æŒæ¡ JPMS èƒ½è®©å¤§å‹é¡¹ç›®çš„è¾¹ç•Œæ›´æ¸…æ™°ã€ä¾èµ–æ›´å¯æ§ï¼›ç†Ÿç»ƒä½¿ç”¨ Maven/Gradle çš„ç‰ˆæœ¬å¹³å°ä¸å†²çªç­–ç•¥ï¼Œèƒ½æ˜¾è‘—é™ä½â€œä¾èµ–åœ°éœ‡â€çš„é£é™©ã€‚å»ºè®®ä¸â€œJVM æ·±å…¥ä¸æ€§èƒ½è°ƒä¼˜â€ã€â€œå¹¶å‘ç¼–ç¨‹é«˜çº§â€ç­‰ç« èŠ‚ç»„åˆç»ƒä¹ ä¸å®è·µã€‚
